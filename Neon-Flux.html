<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#000000">
<title>Neon Flux: Replicant</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&amp;display=swap" rel="stylesheet">
<style>
    :root {
        --bg-color: #000000;
        --glass-bg: rgba(10, 10, 25, 0.9);
        --glass-border: rgba(0, 240, 255, 0.3);
        --accent-primary: #00f0ff;
        --accent-secondary: #ff00aa;
        --accent-success: #00ff88;
        --accent-warn: #ffcc00;
        --accent-danger: #ff4444;
    }
    html, body {
        width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        background: #000;
        color: white; font-family: 'Rajdhani', sans-serif;
        touch-action: none; -webkit-touch-callout: none;
        user-select: none; -webkit-user-select: none;
    }
    canvas { display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
    
    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
        border-radius: 16px;
    }
    
    /* Buttons */
    .btn-neon {
        background: rgba(0, 240, 255, 0.1);
        color: var(--accent-primary);
        border: 1px solid var(--accent-primary);
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 1.1rem;
        padding: 14px 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: all 0.2s ease;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        position: relative;
        overflow: hidden;
        width: 100%;
        border-radius: 6px;
    }
    .btn-neon:active {
        background: var(--accent-primary);
        color: #000;
        box-shadow: 0 0 30px var(--accent-primary);
        transform: scale(0.98);
    }
    
    .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #aaa;
        font-weight: 600;
        padding: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
        font-size: 0.8rem;
        width: 100%;
        border-radius: 6px;
    }
    .btn-secondary:active { background: rgba(255, 255, 255, 0.2); color: #fff; }

    .btn-icon {
        width: 44px; height: 44px;
        border-radius: 50%;
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .btn-icon:active { background: var(--accent-primary); color: black; border-color: var(--accent-primary); }

    /* Difficulty & Mods */
    .btn-diff {
        background: rgba(0,0,0,0.6);
        border: 1px solid #444;
        color: #888;
        font-weight: 700;
        font-size: 0.8rem;
        padding: 10px 4px;
        text-transform: uppercase;
        transition: all 0.2s;
        border-radius: 4px;
    }
    .btn-diff.active { transform: scale(1.05); color: #000; border-color: transparent; box-shadow: 0 0 15px currentColor; }
    .btn-diff[data-diff="NORMAL"].active { background: var(--accent-primary); color: #000; box-shadow: 0 0 15px var(--accent-primary); }
    .btn-diff[data-diff="HARD"].active { background: var(--accent-warn); color: #000; box-shadow: 0 0 15px var(--accent-warn); }
    .btn-diff[data-diff="MASTER"].active { background: var(--accent-secondary); color: #fff; box-shadow: 0 0 15px var(--accent-secondary); }
    .btn-diff[data-diff="CRAZY"].active { background: var(--accent-danger); color: #fff; box-shadow: 0 0 20px var(--accent-danger); animation: pulse-red 1s infinite; }

    .btn-mod {
        background: rgba(0,0,0,0.4);
        border: 1px solid #333;
        color: #666;
        font-weight: 700;
        font-size: 0.9rem;
        padding: 12px 4px;
        border-radius: 6px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    .btn-mod.active {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        text-shadow: 0 0 8px var(--accent-primary);
        box-shadow: inset 0 0 10px rgba(0,240,255,0.2);
    }
    .btn-mod.active::after {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent-primary);
    }

    /* Copy Button Special Style */
    .btn-copy-code {
        background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
        border: 1px solid #444;
        color: #fff;
        font-family: 'Rajdhani', monospace;
        letter-spacing: 1px;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .btn-copy-code svg { width: 16px; height: 16px; fill: currentColor; }
    .btn-copy-code:active {
        border-color: var(--accent-success);
        color: var(--accent-success);
        background: #111;
    }

    @keyframes pulse-red { 0% { box-shadow: 0 0 15px var(--accent-danger); } 50% { box-shadow: 0 0 25px var(--accent-danger); } 100% { box-shadow: 0 0 15px var(--accent-danger); } }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .loader {
        width: 48px; height: 48px;
        border: 3px solid var(--accent-secondary);
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: rotation 1s linear infinite;
    }

    .text-glow { text-shadow: 0 0 10px currentColor; }
    .hidden { display: none !important; }
    .flex-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    
    .input-neon {
        background: rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        padding: 12px;
        border-radius: 6px;
        width: 100%;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s;
    }
    .input-neon:focus { border-color: var(--accent-primary); box-shadow: 0 0 10px rgba(0,240,255,0.2); }
    
    .bg-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 5; pointer-events: none; transition: background 0.3s;
    }
    
    .health-container {
        width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 6px; position: relative; border: 1px solid #444;
    }
    .health-fill {
        height: 100%; background: linear-gradient(90deg, #ff4444, #ffff00, #00ff88); width: 100%; transition: width 0.1s linear; box-shadow: 0 0 10px rgba(0,255,136,0.5);
    }
    .health-fill.danger {
        background: #ff4444; box-shadow: 0 0 15px #ff4444; animation: flash-danger 0.2s infinite;
    }
    @keyframes flash-danger { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .touch-lane {
        flex: 1;
        border-right: 1px solid rgba(255,255,255,0.05);
        transition: background 0.05s;
        pointer-events: none;
    }
    .touch-lane:last-child { border-right: none; }
    .touch-lane:active { background: linear-gradient(to top, rgba(255,255,255,0.1), transparent); }

    .checkbox-wrapper {
        display: flex; align-items: center; justify-content: space-between; cursor: pointer; width: 100%;
        padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .checkbox-wrapper:last-child { border-bottom: none; }
    .checkbox-label { font-size: 0.9rem; font-weight: 600; color: #ddd; }
    
    .checkbox-input {
        appearance: none; width: 20px; height: 20px; border: 1px solid var(--accent-primary);
        background: rgba(0,0,0,0.5); border-radius: 4px; display: grid; place-content: center;
        transition: all 0.2s;
    }
    .checkbox-input::before {
        content: ""; width: 12px; height: 12px; transform: scale(0); transition: 0.1s transform ease-in-out;
        box-shadow: inset 1em 1em var(--accent-primary);
        transform-origin: center;
        clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }
    .checkbox-input:checked::before { transform: scale(1); background: var(--accent-primary); }
    .checkbox-input:checked { box-shadow: 0 0 10px rgba(0,240,255,0.3); }

    .mod-badge {
        font-size: 0.65rem; padding: 2px 4px; border-radius: 2px; background: #333; color: #fff; margin-left: 2px;
    }

    #toast {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
        background: var(--accent-success); color: #000; padding: 8px 16px; border-radius: 20px;
        font-weight: 900; opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 100; pointer-events: none; box-shadow: 0 0 20px var(--accent-success);
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    #gameCanvas {
    pointer-events: none;
        }
</style>
<script id="game-config" type="application/x-game-config">
{ "heroSpeed": { "type": "number", "label": "Hero Speed", "value": 5, "min": 1, "max": 20 },
  "themeColor": { "type": "color", "label": "Theme Color", "value": "#ff0055" },
  "gameTitle": { "type": "text", "label": "Game Title", "value": "Super Jump" } }
</script>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.pointer-events-auto{pointer-events:auto}.absolute{position:absolute}.inset-0{inset:0px}.bottom-0{bottom:0px}.left-0{left:0px}.z-0{z-index:0}.z-50{z-index:50}.z-\[60\]{z-index:60}.z-40{z-index:40}.m-2{margin:0.5rem}.mb-0{margin-bottom:0px}.mb-1{margin-bottom:0.25rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mr-2{margin-right:0.5rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-6{margin-top:1.5rem}.mb-2{margin-bottom:0.5rem}.mb-8{margin-bottom:2rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-1{height:0.25rem}.h-full{height:100%}.h-px{height:1px}.h-\[35\%\]{height:35%}.w-0{width:0px}.w-auto{width:auto}.w-full{width:100%}.w-64{width:16rem}.max-w-xs{max-width:20rem}.flex-1{flex:1 1 0%}.cursor-pointer{cursor:pointer}.touch-none{touch-action:none}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.border{border-width:1px}.border-cyan-800{--tw-border-opacity:1;border-color:rgb(21 94 117 / var(--tw-border-opacity, 1))}.border-yellow-500{--tw-border-opacity:1;border-color:rgb(234 179 8 / var(--tw-border-opacity, 1))}.border-yellow-900\/50{border-color:rgb(113 63 18 / 0.5)}.border-red-900\/30{border-color:rgb(127 29 29 / 0.3)}.border-white\/10{border-color:rgb(255 255 255 / 0.1)}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-black\/90{background-color:rgb(0 0 0 / 0.9)}.bg-gray-800{--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity, 1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-white\/10{background-color:rgb(255 255 255 / 0.1)}.bg-black\/95{background-color:rgb(0 0 0 / 0.95)}.bg-white\/5{background-color:rgb(255 255 255 / 0.05)}.bg-gradient-to-b{background-image:linear-gradient(to bottom, var(--tw-gradient-stops))}.from-black\/90{--tw-gradient-from:rgb(0 0 0 / 0.9) var(--tw-gradient-from-position);--tw-gradient-to:rgb(0 0 0 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-transparent{--tw-gradient-to:transparent var(--tw-gradient-to-position)}.object-cover{object-fit:cover}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-2{padding:0.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pt-4{padding-top:1rem}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-5xl{font-size:3rem;line-height:1}.text-\[10px\]{font-size:10px}.text-\[9px\]{font-size:9px}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.font-black{font-weight:900}.font-bold{font-weight:700}.font-normal{font-weight:400}.uppercase{text-transform:uppercase}.italic{font-style:italic}.leading-none{line-height:1}.tracking-\[0\.4em\]{letter-spacing:0.4em}.tracking-tighter{letter-spacing:-0.05em}.tracking-wider{letter-spacing:0.05em}.tracking-widest{letter-spacing:0.1em}.text-cyan-300{--tw-text-opacity:1;color:rgb(103 232 249 / var(--tw-text-opacity, 1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175 / var(--tw-text-opacity, 1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity, 1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-yellow-100{--tw-text-opacity:1;color:rgb(254 249 195 / var(--tw-text-opacity, 1))}.text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21 / var(--tw-text-opacity, 1))}.text-cyan-400{--tw-text-opacity:1;color:rgb(34 211 238 / var(--tw-text-opacity, 1))}.text-green-400{--tw-text-opacity:1;color:rgb(74 222 128 / var(--tw-text-opacity, 1))}.text-red-400{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.opacity-0{opacity:0}.opacity-70{opacity:0.7}.shadow-\[0_0_15px_rgba\(255\2c 200\2c 0\2c 0\.2\)\]{--tw-shadow:0 0 15px rgba(255,200,0,0.2);--tw-shadow-colored:0 0 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-200{transition-duration:200ms}.duration-500{transition-duration:500ms}</style></head>
<body>

<!-- Assets -->
<audio id="sfx_copy_btn" data-editable="audio" data-label="Copy Button SFX" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky33.mp3" preload="auto"></audio>
<audio id="sfx_copy_success" data-editable="audio" data-label="Copy Success SFX" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/sfx/0001/UI/UI_Quirky_53.mp3" preload="auto"></audio>
<audio id="bgm_main" data-editable="audio" data-label="BGM" src="https://storage.googleapis.com/rezona-ai-prod/games/assets/bgm/0001/City_urban/10-Past-Midnight_Looping.mp3" preload="auto" loop=""></audio>

<!-- Background Layers -->
<video id="bg-video" playsinline="" webkit-playsinline="" crossorigin="anonymous" loop="" muted="" class="absolute inset-0 w-full h-full object-cover z-0 opacity-0 transition-opacity duration-500 bg-black"></video>
<div id="bg-overlay-layer" class="bg-overlay"></div>

<!-- Canvas Layer -->
<canvas id="gameCanvas" width="687" height="1153"></canvas>

<!-- UI Layer -->
<div id="ui-layer"
     class="absolute inset-0 z-50 pointer-events-auto flex flex-col justify-between">
    
    <!-- HUD -->
    <div id="hud" class="hidden w-full flex flex-col p-4 pt-4 pointer-events-auto bg-gradient-to-b from-black/90 to-transparent">
        <div class="flex justify-between items-start w-full">
            <div class="flex flex-col">
                <div class="text-4xl font-bold text-glow leading-none" style="color:var(--accent-primary)">
                    <span id="score-display">0</span>
                </div>
                <div class="text-xs text-gray-400 tracking-widest font-bold">SCORE</div>
                <div id="active-mods-display" class="flex mt-1"></div>
            </div>
            
            <div class="flex gap-3 items-center">
                <div class="flex flex-col items-end mr-2">
                    <div class="text-3xl font-bold text-glow leading-none" style="color:var(--accent-secondary)">
                        <span id="combo-display">0</span>
                    </div>
                    <div class="text-xs text-gray-400 tracking-widest font-bold">COMBO</div>
                </div>
                
                <button id="btn-pause" class="btn-icon">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Health & Progress -->
        <div class="health-container">
            <div id="health-bar" class="health-fill"></div>
        </div>
        <div class="w-full h-1 bg-gray-800 mt-2 rounded overflow-hidden">
            <div id="progress-bar" class="h-full bg-white w-0 transition-all duration-200"></div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="absolute inset-0 flex-center glass-panel pointer-events-auto z-50 m-2 overflow-y-auto no-scrollbar">
        <div class="w-full max-w-xs flex flex-col items-center py-6 px-4">
            <h1 class="text-5xl font-black mb-0 tracking-tighter text-center italic" style="color:var(--accent-primary); text-shadow: 0 0 20px var(--accent-primary);">NEON FLUX</h1>
            <p class="text-xs text-gray-300 mb-6 tracking-[0.4em] text-center font-bold">REPLICANT</p>
            
            <!-- Difficulty -->
            <div class="w-full mb-4">
                <div class="grid grid-cols-4 gap-2 w-full">
                    <button class="btn-diff active" data-diff="NORMAL">Norm</button>
                    <button class="btn-diff" data-diff="HARD">Hard</button>
                    <button class="btn-diff" data-diff="MASTER">Mstr</button>
                    <button class="btn-diff" data-diff="CRAZY">CRZY</button>
                </div>
            </div>

            <!-- Mods & Settings Buttons -->
            <div class="w-full flex gap-2 mb-6">
                <button id="btn-open-mods" class="flex-1 btn-secondary text-xs flex flex-col items-center justify-center py-3">
                    <span class="mb-1">MODS</span>
                    <span id="mods-count" class="text-[9px] text-accent-primary">NONE</span>
                </button>
                <button id="btn-open-settings" class="flex-1 btn-secondary text-xs flex flex-col items-center justify-center py-3">
                    <span class="mb-1">SETTINGS</span>
                    <span class="text-[9px] text-gray-400">CONFIG</span>
                </button>
            </div>

            <!-- Import Section -->
            <div class="w-full mb-6 flex flex-col gap-3">
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] text-gray-400 uppercase tracking-widest">Import Media</label>
                    <div class="flex gap-2">
                        <input type="text" id="url-input" class="input-neon" placeholder="Paste URL..." autocomplete="off">
                        <button id="btn-load-url" class="btn-secondary w-auto px-4 text-cyan-300 border-cyan-800 font-bold">LOAD</button>
                    </div>
                    
                    <div class="flex gap-2 mt-2">
                        <input type="file" id="file-upload" accept="audio/*,video/*" class="hidden">
                        <button id="btn-trigger-upload" class="btn-secondary w-full text-accent-primary border-accent-primary" style="background: rgba(0, 240, 255, 0.05);">
                            UPLOAD LOCAL FILE
                        </button>
                    </div>

                    <div class="flex items-center justify-between mt-2">
                        <div class="text-[9px] text-gray-500">MP4: Video BG • MP3: Audio Only</div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="force-video" class="checkbox-input" style="width:16px;height:16px;">
                            <span class="text-[10px] text-accent-primary font-bold tracking-wider">FORCE VIDEO</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="h-px bg-white/10 w-full mb-6"></div>

            <!-- Request Song System -->
            <div class="w-full mb-4 flex flex-col gap-2">
                <label class="text-[10px] text-gray-400 uppercase tracking-widest text-accent-warn">Song Request System</label>
                <input type="text" id="request-input" class="input-neon text-accent-primary font-bold" placeholder="Enter Song Name / Keyword..." autocomplete="off">
                <input type="text" id="signal-url-input" class="input-neon border-yellow-900/50 text-yellow-100 text-[10px]" value="http://127.0.0.1:36525/latest?query=target" placeholder="Webhook URL (must contain 'target')" autocomplete="off">
                <button id="btn-send-request" class="btn-neon text-sm py-3 mt-1 border-yellow-500 text-yellow-400 shadow-[0_0_15px_rgba(255,200,0,0.2)]">SEND REQUEST</button>
            </div>

            <!-- Copy Code Button -->
            <button id="btn-copy-source" class="btn-secondary btn-copy-code w-full py-4 text-sm font-bold uppercase tracking-widest">
                <svg viewBox="0 0 24 24"><path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                COPY SOURCE CODE
            </button>
            
            <div class="text-[9px] text-center text-gray-600 uppercase tracking-widest mt-6">
                Mobile Portrait • Touch Only
            </div>
        </div>
    </div>

    <!-- Mods Selection Overlay -->
    <div id="mods-overlay" class="hidden absolute inset-0 flex-center bg-black/90 pointer-events-auto z-[60] backdrop-blur-sm">
        <div class="w-full max-w-xs p-6 glass-panel">
            <h2 class="text-2xl font-bold text-white mb-4 tracking-widest text-center">SELECT MODS</h2>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button class="btn-mod" data-mod="NF">NO FAIL<div class="text-[9px] mt-1 font-normal opacity-70">Cannot die</div></button>
                <button class="btn-mod" data-mod="EZ">EASY<div class="text-[9px] mt-1 font-normal opacity-70">Large hits, less dmg</div></button>
                <button class="btn-mod" data-mod="HR">HARD ROCK<div class="text-[9px] mt-1 font-normal opacity-70">Strict timing, high dmg</div></button>
                <button class="btn-mod" data-mod="HD">HIDDEN<div class="text-[9px] mt-1 font-normal opacity-70">Notes fade out</div></button>
                <button class="btn-mod" data-mod="DT">DOUBLE TIME<div class="text-[9px] mt-1 font-normal opacity-70">1.5x Speed</div></button>
                <button class="btn-mod" data-mod="HT">HALF TIME<div class="text-[9px] mt-1 font-normal opacity-70">0.75x Speed</div></button>
            </div>
            <button id="btn-close-mods" class="btn-neon">CONFIRM</button>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="hidden absolute inset-0 flex-center bg-black/90 pointer-events-auto z-[60] backdrop-blur-sm">
        <div class="w-full max-w-xs p-6 glass-panel">
            <h2 class="text-2xl font-bold text-white mb-6 tracking-widest text-center">SETTINGS</h2>
            <div class="flex flex-col gap-2 mb-6 w-full">
                <label class="checkbox-wrapper"><span class="checkbox-label">SFX (Sound Effects)</span><input type="checkbox" id="set-sfx" class="checkbox-input" checked=""></label>
                <label class="checkbox-wrapper"><span class="checkbox-label">Visual FX (Particles)</span><input type="checkbox" id="set-fx" class="checkbox-input" checked=""></label>
                <label class="checkbox-wrapper"><span class="checkbox-label">Arrow Background</span><input type="checkbox" id="set-lane-bg" class="checkbox-input" checked=""></label>
                <label class="checkbox-wrapper"><span class="checkbox-label">Dark Background</span><input type="checkbox" id="set-bg-dim" class="checkbox-input" checked=""></label>
            </div>
            <button id="btn-close-settings" class="btn-neon">CLOSE</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden absolute inset-0 flex-center glass-panel pointer-events-auto z-50 m-2">
        <span class="loader mb-6"></span>
        <h2 class="text-2xl font-bold text-white tracking-widest">PROCESSING</h2>
        <p id="loading-text" class="text-sm text-cyan-400 mt-2 text-center px-4">Analyzing frequency data...</p>
    </div>

    <!-- Pause Menu -->
    <div id="pause-menu" class="hidden absolute inset-0 flex-center glass-panel pointer-events-auto z-50 m-2 bg-black/95">
        <h2 class="text-4xl font-bold text-white mb-8 tracking-widest">PAUSED</h2>
        <div class="flex flex-col gap-4 w-64">
            <button id="btn-resume" class="btn-neon">RESUME</button>
            <button id="btn-restart-pause" class="btn-secondary">RESTART</button>
            <button id="btn-exit-pause" class="btn-secondary text-red-400 border-red-900/30">EXIT TO MENU</button>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="hidden absolute inset-0 flex-center glass-panel pointer-events-auto z-50 m-2">
        <h2 id="go-title" class="text-3xl font-bold text-white mb-2 tracking-tighter">TRACK COMPLETE</h2>
        <div class="text-5xl mb-6 font-bold text-glow" style="color:var(--accent-primary)">
            <span id="final-score">0</span>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-8 w-full px-4">
            <div class="flex flex-col items-center p-2 bg-white/5 rounded border border-white/10">
                <div class="text-[9px] text-gray-400 tracking-widest mb-1">PERFECT</div>
                <div id="stat-perfect" class="text-xl font-bold text-green-400">0</div>
            </div>
            <div class="flex flex-col items-center p-2 bg-white/5 rounded border border-white/10">
                <div class="text-[9px] text-gray-400 tracking-widest mb-1">GOOD</div>
                <div id="stat-good" class="text-xl font-bold text-cyan-400">0</div>
            </div>
            <div class="flex flex-col items-center p-2 bg-white/5 rounded border border-white/10">
                <div class="text-[9px] text-gray-400 tracking-widest mb-1">MISS</div>
                <div id="stat-miss" class="text-xl font-bold text-red-400">0</div>
            </div>
        </div>
        <button id="btn-exit-gameover" class="btn-neon w-full max-w-xs">BACK TO MENU</button>
    </div>

    <!-- Touch Controls Overlay -->
    <div id="touch-controls" class="absolute bottom-0 left-0 w-full h-[35%] flex pointer-events-auto z-40 touch-none">
        <div class="touch-lane" data-lane="0"></div>
        <div class="touch-lane" data-lane="1"></div>
        <div class="touch-lane" data-lane="2"></div>
        <div class="touch-lane" data-lane="3"></div>
    </div>

    <!-- Toast -->
    <div id="toast">SOURCE COPIED!</div>
</div>

<script>
/**
 * NEON FLUX: REPLICANT
 * Features:
 * - URL Import & Local File Upload
 * - Procedural beatmapping
 * - Copy Source Code Feature
 */

// --- CONFIGURATION ---
const DIFFICULTY_PRESETS = {
    NORMAL: { speed: 8,  sensitivity: 1.4, holdChance: 0.2 },
    HARD:   { speed: 11, sensitivity: 1.15, holdChance: 0.3 },
    MASTER: { speed: 14, sensitivity: 0.95, holdChance: 0.4 },
    CRAZY:  { speed: 15, sensitivity: 0.75, holdChance: 0.5 }
};

const CONFIG = {
    lanes: 4,
    inputOffset: 0, 
    basePoints: 100,
    holdTickPoints: 10,
    holdCompletePoints: 200,
    startHealth: 100,
    damageMiss: 15,
    healHit: 2
};

// --- GLOBALS ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
const videoEl = document.getElementById('bg-video');
const bgOverlay = document.getElementById('bg-overlay-layer');

let cw = 0, ch = 0;
let animationFrameId;
let lastTime = 0;

// Game State
let gameState = 'MENU'; 
let isPaused = false;
let audioCtx = null;
let currentBuffer = null; 
let audioSource = null; 
let isVideoMode = false;
let startTime = 0;
let speedMultiplier = 1.0;

// Gameplay Stats
let score = 0;
let combo = 0;
let health = 100;
let stats = { perfect: 0, good: 0, miss: 0 };
let currentDifficulty = 'NORMAL';

// Mods
let activeMods = { NF: false, EZ: false, HR: false, HD: false, DT: false, HT: false };

// Settings
let SETTINGS = { sfx: true, fx: true, laneBg: true, bgDim: true };

// Chart Data
let notes = []; 
let trackDuration = 0;
let laneHeld = [false, false, false, false];

// Visuals
const LANE_COLORS = ['#FF00FF', '#00FFFF', '#00FF00', '#FFAA00']; 
const LANE_GLOWS = ['rgba(255,0,255,0.6)', 'rgba(0,255,255,0.6)', 'rgba(0,255,0,0.6)', 'rgba(255,170,0,0.6)'];
let particles = [];
let popups = [];
let laneEffects = [0, 0, 0, 0]; 

// --- AUDIO SYSTEM ---
const audioManager = {
    buffers: {},
    init: () => {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            ['sfx_copy_btn', 'sfx_copy_success'].forEach(id => {
                const el = document.getElementById(id);
                if (!el || !el.src) return;

                fetch(el.src)
                    .then(r => r.arrayBuffer())
                    .then(b => audioCtx.decodeAudioData(b))
                    .then(buf => {
                        audioManager.buffers[id] = buf;
                    })
                    .catch(err => console.error('Audio load error', err));
            });
        }

        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    },

    playBuffer: (id) => {
        if (!audioCtx || !audioManager.buffers[id]) return;
        const src = audioCtx.createBufferSource();
        src.buffer = audioManager.buffers[id];
        src.connect(audioCtx.destination);
        src.start(0);
    }
};
    
    playBuffer: (id) => {
        if (!audioCtx || !SETTINGS.sfx || !audioManager.buffers[id]) return;
        const src = audioCtx.createBufferSource();
        src.buffer = audioManager.buffers[id];
        src.connect(audioCtx.destination);
        src.start(0);
    },

    playSynth: (type) => {
        if (!audioCtx || !SETTINGS.sfx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        
        if (type === 'PERFECT') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        } else if (type === 'MISS') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.1);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        }
        osc.start(now);
        osc.stop(now + 0.1);
    }
};

// --- UI HANDLERS ---
function initUI() {
    // Difficulty
    document.querySelectorAll('.btn-diff').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.btn-diff').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentDifficulty = e.target.getAttribute('data-diff');
        });
    });

    // Mods System
    const modOverlay = document.getElementById('mods-overlay');
    document.getElementById('btn-open-mods').addEventListener('click', () => modOverlay.classList.remove('hidden'));
    document.getElementById('btn-close-mods').addEventListener('click', () => {
        modOverlay.classList.add('hidden');
        updateModsDisplay();
    });

    document.querySelectorAll('.btn-mod').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const mod = btn.dataset.mod;
            activeMods[mod] = !activeMods[mod];
            if (mod === 'DT' && activeMods.DT) activeMods.HT = false;
            if (mod === 'HT' && activeMods.HT) activeMods.DT = false;
            if (mod === 'EZ' && activeMods.EZ) activeMods.HR = false;
            if (mod === 'HR' && activeMods.HR) activeMods.EZ = false;
            
            document.querySelectorAll('.btn-mod').forEach(b => {
                const m = b.dataset.mod;
                b.classList.toggle('active', activeMods[m]);
            });
        });
    });

    function updateModsDisplay() {
        const active = Object.keys(activeMods).filter(k => activeMods[k]);
        const modsCountSpan = document.getElementById('mods-count');
        const activeModsDisplay = document.getElementById('active-mods-display');
        
        if (active.length === 0) {
            modsCountSpan.innerText = "NONE";
            modsCountSpan.className = "text-[9px] text-gray-500";
            activeModsDisplay.innerHTML = "";
        } else {
            modsCountSpan.innerText = active.join(", ");
            modsCountSpan.className = "text-[9px] text-accent-primary";
            activeModsDisplay.innerHTML = active.map(m => `<span class="mod-badge">${m}</span>`).join('');
        }
    }

    // Settings System
    const settingsOverlay = document.getElementById('settings-overlay');
    document.getElementById('btn-open-settings').addEventListener('click', () => settingsOverlay.classList.remove('hidden'));
    document.getElementById('btn-close-settings').addEventListener('click', () => settingsOverlay.classList.add('hidden'));
    
    document.getElementById('set-sfx').addEventListener('change', (e) => SETTINGS.sfx = e.target.checked);
    document.getElementById('set-fx').addEventListener('change', (e) => SETTINGS.fx = e.target.checked);
    document.getElementById('set-lane-bg').addEventListener('change', (e) => SETTINGS.laneBg = e.target.checked);
    document.getElementById('set-bg-dim').addEventListener('change', (e) => {
        SETTINGS.bgDim = e.target.checked;
        if (isVideoMode) bgOverlay.style.background = SETTINGS.bgDim ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.3)';
    });

    // Copy Code Button
    document.getElementById('btn-copy-source').addEventListener('click', async () => {
        audioManager.init();
        audioManager.playBuffer('sfx_copy_btn');
        try {
            await navigator.clipboard.writeText(document.documentElement.outerHTML);
            audioManager.playBuffer('sfx_copy_success');
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        } catch (err) {
            console.error('Copy failed', err);
            alert('Failed to copy source code.');
        }
    });

    // Touch Inputs
    const touchZone = document.getElementById('touch-controls');
    touchZone.querySelectorAll('div').forEach(div => {
        const rawLane = parseInt(div.dataset.lane);
        const handlePress = (e) => {
            e.preventDefault();
            div.releasePointerCapture(e.pointerId);
            laneHeld[rawLane] = true;
            if (gameState === 'PLAYING' && !isPaused) {
                checkHit(rawLane);
                laneEffects[rawLane] = 1;
            } else if (gameState === 'MENU') {
                audioManager.init();
            }
        };
        const handleRelease = (e) => { e.preventDefault(); laneHeld[rawLane] = false; };
        div.addEventListener('pointerdown', handlePress);
        div.addEventListener('pointerup', handleRelease);
        div.addEventListener('pointerleave', handleRelease);
        div.addEventListener('pointercancel', handleRelease);
    });

    // Button Actions
    document.getElementById('btn-load-url').addEventListener('click', handleUrlLoad);
    document.getElementById('btn-trigger-upload').addEventListener('click', () => document.getElementById('file-upload').click());
    document.getElementById('file-upload').addEventListener('change', handleFileUpload);
    document.getElementById('btn-pause').addEventListener('click', togglePause);
    document.getElementById('btn-resume').addEventListener('click', togglePause);
    document.getElementById('btn-restart-pause').addEventListener('click', restartGame);
    document.getElementById('btn-exit-pause').addEventListener('click', exitToMenu);
    document.getElementById('btn-exit-gameover').addEventListener('click', exitToMenu);
    document.getElementById('btn-send-request').addEventListener('click', handleSendRequest);
}

// --- REQUEST SONG HANDLER ---
function handleSendRequest() {
    const template = document.getElementById('signal-url-input').value.trim();
    const query = document.getElementById('request-input').value.trim();
    const btn = document.getElementById('btn-send-request');

    if(!template || !query || template.indexOf('target') === -1) {
        alert("Enter a query and valid Webhook URL containing 'target'.");
        return;
    }

    const finalUrl = template.replace('target', encodeURIComponent(query));
    const originalText = btn.innerText;
    btn.innerText = "SENDING...";
    btn.disabled = true;

    fetch(finalUrl, { method: 'GET', mode: 'no-cors' })
        .then(() => {
            btn.innerText = "SENT!";
            btn.style.borderColor = "#00ff88";
            btn.style.color = "#00ff88";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.borderColor = "";
                btn.style.color = "";
            }, 2000);
        })
        .catch(err => {
            btn.innerText = "ERROR";
            setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000);
        });
}

// --- BEAT DETECTION ALGORITHM ---
async function analyzeAudio(buffer) {
    const channelData = buffer.getChannelData(0);
    const sampleRate = buffer.sampleRate;
    
    notes = [];
    const windowSize = 0.05; 
    const samplesPerWindow = Math.floor(sampleRate * windowSize);
    const settings = DIFFICULTY_PRESETS[currentDifficulty];
    const sensitivity = settings.sensitivity;
    
    const energyMap = [];
    for (let i = 0; i < channelData.length; i += samplesPerWindow) {
        let sum = 0;
        for (let j = 0; j < samplesPerWindow && i + j < channelData.length; j++) {
            const s = channelData[i + j];
            sum += s * s;
        }
        energyMap.push({ time: i / sampleRate, energy: Math.sqrt(sum / samplesPerWindow) });
    }
    
    const historySize = 25;
    for (let i = historySize; i < energyMap.length; i++) {
        let localAvg = 0;
        for (let j = 1; j <= historySize; j++) localAvg += energyMap[i - j].energy;
        localAvg /= historySize;
        
        const current = energyMap[i];
        if (current.energy > localAvg * sensitivity && current.energy > 0.01) {
            if (current.energy > energyMap[i-1].energy && (i+1 >= energyMap.length || current.energy > energyMap[i+1].energy)) {
                const minDistance = currentDifficulty === 'CRAZY' ? 0.08 : (currentDifficulty === 'MASTER' ? 0.12 : 0.18);
                if (notes.length > 0 && current.time - notes[notes.length-1].time < minDistance) continue;
                
                const seed = Math.floor(current.time * 12345);
                notes.push({
                    time: current.time,
                    lane: seed % CONFIG.lanes,
                    type: 'TAP',
                    duration: 0,
                    hit: false, missed: false, holding: false, processed: false
                });
            }
        }
    }

    // Convert to Holds
    for (let i = 0; i < notes.length - 1; i++) {
        const curr = notes[i];
        const next = notes[i+1];
        const gap = next.time - curr.time;
        if (gap > 0.5 && Math.random() < settings.holdChance) {
            curr.type = 'HOLD';
            curr.duration = Math.min(gap - 0.2, 2.0);
        }
    }
}

// --- CORE FUNCTIONS ---
function initGame() {
    const ro = new ResizeObserver(entries => {
        const entry = entries[0];
        const dpr = window.devicePixelRatio || 1;
        cw = entry.contentRect.width;
        ch = entry.contentRect.height;
        canvas.width = cw * dpr;
        canvas.height = ch * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    });
    ro.observe(document.body);
    
    initUI();
    requestAnimationFrame(gameLoop);
}

function exitToMenu() {
    stopPlayback();
    gameState = 'MENU';
    isPaused = false;
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('pause-menu').classList.add('hidden');
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
    document.getElementById('start-screen').classList.add('flex-center');
    videoEl.style.opacity = 0;
    videoEl.src = "";
    resetGameVars();
}

function stopPlayback() {
    if (audioSource) { try { audioSource.stop(); } catch(e){} audioSource = null; }
    if (videoEl) videoEl.pause();
}

function resetGameVars() {
    score = 0; combo = 0; health = CONFIG.startHealth;
    laneHeld = [false, false, false, false];
}

function restartGame() {
    stopPlayback();
    document.getElementById('pause-menu').classList.add('hidden');
    document.getElementById('game-over-screen').classList.add('hidden');
    isPaused = false;
    startGame();
}

function togglePause() {
    if (gameState !== 'PLAYING') return;
    isPaused = !isPaused;
    const pauseMenu = document.getElementById('pause-menu');
    
    if (isPaused) {
        if (isVideoMode) videoEl.pause();
        else if (audioCtx) audioCtx.suspend();
        pauseMenu.classList.remove('hidden');
    } else {
        pauseMenu.classList.add('hidden');
        if (isVideoMode) videoEl.play();
        else audioCtx.resume();
    }
}

function handleGlobalInput(e) {
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}
window.addEventListener('pointerdown', handleGlobalInput, { passive: false });

// --- LOADING & IMPORTING ---
async function handleUrlLoad() {
    const url = document.getElementById('url-input').value.trim();
    if (!url) return;
    audioManager.init();
    
    const ext = url.split('.').pop().toLowerCase().split('?')[0];
    const videoExts = ['mp4', 'webm', 'ogg', 'mov', 'm4v', 'mkv'];
    const forceVideo = document.getElementById('force-video').checked;
    isVideoMode = forceVideo || videoExts.includes(ext);
    
    setLoading(true, isVideoMode ? "Fetching Video..." : "Fetching Audio...");
    try {
        if (isVideoMode) { videoEl.src = url; videoEl.load(); }
        const response = await fetch(url);
        if (!response.ok) throw new Error("Network error");
        await processAudio(await response.arrayBuffer());
    } catch (e) {
        setLoading(false);
        alert("Load failed. Ensure URL allows CORS.");
    }
}

async function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    audioManager.init();
    
    const isVideo = file.type.startsWith('video');
    const forceVideo = document.getElementById('force-video').checked;
    isVideoMode = forceVideo || isVideo;

    setLoading(true, "Processing File...");
    try {
        if (isVideoMode) { videoEl.src = URL.createObjectURL(file); videoEl.load(); }
        await processAudio(await file.arrayBuffer());
    } catch (err) {
        setLoading(false);
        alert("File load failed.");
    }
}

async function processAudio(arrayBuffer) {
    setLoading(true, "Decoding Data...");
    try {
        const decodedBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        currentBuffer = decodedBuffer;
        trackDuration = decodedBuffer.duration;
        setLoading(true, `Generating ${currentDifficulty} Chart...`);
        setTimeout(async () => {
            await analyzeAudio(decodedBuffer);
            startGame();
        }, 50);
    } catch (e) {
        setLoading(false);
        alert("Decode failed. Format not supported.");
    }
}

function setLoading(active, text = "") {
    const el = document.getElementById('loading-screen');
    if (active) {
        el.classList.remove('hidden');
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('flex-center');
        document.getElementById('loading-text').innerText = text;
        gameState = 'ANALYZING';
    } else {
        el.classList.add('hidden');
    }
}

function startGame() {
    setLoading(false);
    gameState = 'PLAYING';
    resetGameVars();
    stats = { perfect: 0, good: 0, miss: 0 };
    particles = []; popups = [];
    
    speedMultiplier = activeMods.DT ? 1.5 : (activeMods.HT ? 0.75 : 1.0);
    notes.forEach(n => { n.hit = false; n.missed = false; n.processed = false; n.holding = false; });
    
    document.getElementById('hud').classList.remove('hidden');
    updateHUD();
    
    if (isVideoMode) {
        videoEl.style.opacity = 0.6; 
        bgOverlay.style.background = SETTINGS.bgDim ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.3)';
        videoEl.currentTime = 0; videoEl.muted = false; videoEl.loop = false;
        videoEl.playbackRate = speedMultiplier;
        videoEl.play().catch(e => console.log("Video play error:", e));
        videoEl.onended = () => { if(gameState === 'PLAYING') endGame(true); };
    } else {
        videoEl.style.opacity = 0;
        bgOverlay.style.background = 'transparent';
        audioSource = audioCtx.createBufferSource();
        audioSource.buffer = currentBuffer;
        audioSource.playbackRate.value = speedMultiplier;
        audioSource.connect(audioCtx.destination);
        audioSource.start(0);
        startTime = audioCtx.currentTime;
        audioSource.onended = () => { if(gameState === 'PLAYING') endGame(true); };
    }
}

function endGame(win = false) {
    gameState = 'GAMEOVER';
    stopPlayback();
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('game-over-screen').classList.remove('hidden');
    document.getElementById('go-title').innerText = win ? "TRACK COMPLETE" : "GAME OVER";
    document.getElementById('go-title').style.color = win ? "#fff" : "#ff4444";
    document.getElementById('final-score').innerText = score.toLocaleString();
    document.getElementById('stat-perfect').innerText = stats.perfect;
    document.getElementById('stat-good').innerText = stats.good;
    document.getElementById('stat-miss').innerText = stats.miss;
    if (!win) vibrate('heavy');
}

// --- GAME LOOP & LOGIC ---
function getGameTime() {
    return isVideoMode ? videoEl.currentTime : (audioCtx.currentTime - startTime) * speedMultiplier;
}

function vibrate(style) {
    if (window.webkit?.messageHandlers?.rezonaBridge) {
        window.webkit.messageHandlers.rezonaBridge.postMessage({
            action: 'vibrate', requestId: 'h5-' + Date.now(), version: '1.0', params: { style }
        });
    }
}

function takeDamage() {
    const dmg = activeMods.EZ ? CONFIG.damageMiss * 0.5 : (activeMods.HR ? CONFIG.damageMiss * 1.5 : CONFIG.damageMiss);
    health -= dmg;
    if (health <= 0) {
        health = 0; updateHUD();
        if (!activeMods.NF) endGame(false);
    }
}

function checkHit(lane) {
    const songTime = getGameTime() - (CONFIG.inputOffset / 1000);
    let hitWindow = 0.25, perfectWindow = 0.08;
    
    if (activeMods.EZ) { hitWindow *= 1.4; perfectWindow *= 1.4; }
    else if (activeMods.HR) { hitWindow *= 0.7; perfectWindow *= 0.7; }

    let bestNote = null, minDiff = Infinity;
    for (let note of notes) {
        if (note.lane === lane && !note.hit && !note.missed) {
            const diff = note.time - songTime;
            if (Math.abs(diff) < hitWindow && Math.abs(diff) < minDiff) {
                minDiff = Math.abs(diff); bestNote = note;
            }
        }
    }
    
    if (bestNote) {
        bestNote.hit = true;
        let points = 0, text = "", color = "#fff";
        
        if (minDiff <= perfectWindow) {
            points = 300; text = "PERFECT"; color = "#00FF80";
            stats.perfect++; createParticles(lane, 15, color);
            audioManager.playSynth('PERFECT'); vibrate('light');
        } else {
            points = 100; text = "GOOD"; color = "#00E5FF";
            stats.good++; createParticles(lane, 8, color);
            audioManager.playSynth('GOOD');
        }

        if (bestNote.type === 'HOLD') { bestNote.holding = true; text = "HOLD"; }
        else combo++;
        
        score += points * Math.min(Math.max(combo, 1), 10);
        health = Math.min(health + (activeMods.EZ ? CONFIG.healHit * 1.5 : CONFIG.healHit), 100);
        
        if (SETTINGS.fx) popups.push({ text, x: getLaneX(lane), y: ch * 0.65, life: 0.8, color, scale: 1.2 });
        updateHUD();
    }
}

function updateHUD() {
    document.getElementById('score-display').innerText = score.toLocaleString();
    document.getElementById('combo-display').innerText = combo;
    const hpBar = document.getElementById('health-bar');
    hpBar.style.width = `${health}%`;
    hpBar.classList.toggle('danger', health < 30);
}

// --- RENDERING ---
function getLaneX(lane) { return lane * (cw / CONFIG.lanes) + (cw / CONFIG.lanes) / 2; }

function createParticles(lane, count, color) {
    if (!SETTINGS.fx) return;
    const x = getLaneX(lane);
    const y = ch - 120;
    for (let i = 0; i < count; i++) {
        particles.push({
            x, y, vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20 - 10,
            life: 1.0, color, size: Math.random() * 5 + 2
        });
    }
}

function gameLoop() {
    const now = performance.now();
    const dt = (now - lastTime) / 1000;
    lastTime = now;
    
    ctx.clearRect(0, 0, cw, ch);
    const laneWidth = cw / CONFIG.lanes;
    const targetY = ch - 120;
    
    if (gameState === 'PLAYING' && !isPaused) {
        const songTime = getGameTime();
        const noteSpeedPx = DIFFICULTY_PRESETS[currentDifficulty].speed * 80; 
        
        // Lanes
        for (let i = 0; i < CONFIG.lanes; i++) {
            if (SETTINGS.laneBg) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(i * laneWidth, 0); ctx.lineTo(i * laneWidth, ch); ctx.stroke();
            }
            if (laneEffects[i] > 0.01 || laneHeld[i]) {
                const alpha = Math.max(laneEffects[i], laneHeld[i] ? 0.3 : 0);
                const grad = ctx.createLinearGradient(0, targetY, 0, 0);
                grad.addColorStop(0, LANE_GLOWS[i].replace('0.6', alpha * 0.6));
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad; ctx.fillRect(i * laneWidth, 0, laneWidth, ch);
                if (laneEffects[i] > 0) laneEffects[i] -= dt * 5;
            }
            drawNote(ctx, getLaneX(i), targetY, 35 * (1 + laneEffects[i]*0.2 + (laneHeld[i]?0.1:0)), LANE_COLORS[i], LANE_GLOWS[i], true);
        }
        
        // Notes
        for (let note of notes) {
            if (note.missed || note.processed) continue;
            const timeDiff = note.time - songTime;
            const y = targetY - (timeDiff * noteSpeedPx);
            let alpha = activeMods.HD ? Math.min(Math.max(timeDiff - 0.2, 0) * 2, 1) : 1.0;

            if (note.type === 'HOLD') {
                const yHead = y;
                const yTail = targetY - ((note.time + note.duration - songTime) * noteSpeedPx);
                if (yTail < ch && yHead > -50) drawHoldBody(ctx, getLaneX(note.lane), yHead, yTail, 40, LANE_COLORS[note.lane], alpha);
                
                if (note.hit) {
                    if (laneHeld[note.lane]) {
                        score += 1; createParticles(note.lane, 1, LANE_COLORS[note.lane]);
                        if (songTime >= note.time + note.duration) {
                            note.processed = true; score += CONFIG.holdCompletePoints; combo++;
                            if (SETTINGS.fx) popups.push({ text: "COMPLETE", x: getLaneX(note.lane), y: targetY, life: 0.5, color: "#fff", scale: 1 });
                            audioManager.playSynth('PERFECT'); updateHUD();
                        }
                    } else if (songTime < note.time + note.duration - 0.1) {
                        note.processed = true; note.missed = true; combo = 0; stats.miss++;
                        takeDamage(); audioManager.playSynth('MISS'); updateHUD();
                    }
                }
            }
            
            if (note.type === 'TAP' || !note.hit) {
                if (timeDiff < -0.2 && !note.hit && !note.missed) {
                    note.missed = true; stats.miss++; combo = 0; takeDamage();
                    if (SETTINGS.fx) popups.push({ text: "MISS", x: getLaneX(note.lane), y: targetY, life: 0.5, color: "#ff4444", scale: 1 });
                    audioManager.playSynth('MISS'); updateHUD();
                } else if (y > -50 && y < ch + 50) {
                    drawNote(ctx, getLaneX(note.lane), y, 30, LANE_COLORS[note.lane], LANE_GLOWS[note.lane], false, alpha);
                }
            }
        }
        
        // Particles & Popups
        ctx.globalAlpha = 1;
        particles = particles.filter(p => {
            p.x += p.vx; p.y += p.vy; p.life -= dt * 3; p.vy += 0.5;
            if (p.life > 0) {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
            }
            return p.life > 0;
        });
        
        popups = popups.filter(p => {
            p.y -= dt * 80; p.life -= dt;
            if (p.life > 0) {
                ctx.save(); ctx.translate(p.x, p.y);
                const scale = p.scale * (0.8 + p.life * 0.2);
                ctx.scale(scale, scale); ctx.fillStyle = p.color; ctx.font = "bold 32px 'Rajdhani'";
                ctx.textAlign = "center"; ctx.shadowColor = p.color; ctx.shadowBlur = 10;
                ctx.fillText(p.text, 0, 0); ctx.restore();
            }
            return p.life > 0;
        });
        
        if (trackDuration > 0) document.getElementById('progress-bar').style.width = `${Math.min((songTime / trackDuration) * 100, 100)}%`;
        
    } else {
        // Menu Visualizer
        const time = now / 1000;
        for (let i = 0; i < CONFIG.lanes; i++) {
            const x = getLaneX(i);
            const y = ch - 120 + Math.sin(time * 3 + i) * 15;
            ctx.globalAlpha = 0.2;
            drawNote(ctx, x, y, 35, LANE_COLORS[i], LANE_GLOWS[i], true);
        }
        ctx.globalAlpha = 1;
    }
    
    animationFrameId = requestAnimationFrame(gameLoop);
}

function drawNote(ctx, x, y, r, c, g, hollow, alpha = 1.0) {
    if (alpha <= 0) return;
    ctx.save(); ctx.globalAlpha = alpha; ctx.shadowBlur = 15; ctx.shadowColor = g;
    ctx.fillStyle = c; ctx.strokeStyle = c; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2);
    if (hollow) ctx.stroke();
    else { ctx.fill(); ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x, y, r * 0.4, 0, Math.PI * 2); ctx.fill(); }
    ctx.restore();
}

function drawHoldBody(ctx, x, yHead, yTail, w, c, alpha = 1.0) {
    const h = yHead - yTail;
    if (h <= 0 || alpha <= 0) return;
    ctx.save(); ctx.globalAlpha = 0.6 * alpha; ctx.shadowBlur = 10; ctx.shadowColor = c;
    const grad = ctx.createLinearGradient(0, yTail, 0, yHead);
    grad.addColorStop(0, 'rgba(255,255,255,0.1)'); grad.addColorStop(1, c);
    ctx.fillStyle = grad; ctx.fillRect(x - w/2, yTail, w, h);
    ctx.fillStyle = '#fff'; ctx.globalAlpha = 0.8 * alpha; ctx.fillRect(x - 2, yTail, 4, h);
    ctx.restore();
}

document.addEventListener('DOMContentLoaded', initGame);
</script>

</body></html>
